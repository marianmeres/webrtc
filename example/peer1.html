<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Peer 1</title>
	<style>
		body { font-family: sans-serif; padding: 1rem; }
		h2 { margin-bottom: 1rem; color: #333; }
		#status { margin-bottom: 1rem; padding: 0.5rem; background: #f0f0f0; }
		#log { height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 0.5rem; margin-bottom: 1rem; font-size: 0.85rem; }
		.controls { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
		input { flex: 1; padding: 0.5rem; }
		button { padding: 0.5rem 1rem; cursor: pointer; }
	</style>
</head>
<body>
	<h2>Peer 1 (Offerer)</h2>
	<div id="status">Status: Initializing...</div>
	<div id="log"></div>
	<div class="controls">
		<input type="text" id="message" placeholder="Type a message...">
		<button id="send">Send</button>
	</div>
	<button id="connect">Connect</button>

	<script type="module">
		import { WebRtcManager } from './dist/webrtc.js';

		const factory = {
			createPeerConnection: (config) => new RTCPeerConnection(config),
			getUserMedia: (constraints) => navigator.mediaDevices.getUserMedia(constraints),
			enumerateDevices: () => navigator.mediaDevices.enumerateDevices(),
		};

		const manager = new WebRtcManager(factory, {
			peerConfig: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] },
			dataChannelLabel: 'chat',
			debug: true,
		});

		const statusEl = document.getElementById('status');
		const logEl = document.getElementById('log');
		const messageInput = document.getElementById('message');
		const sendBtn = document.getElementById('send');
		const connectBtn = document.getElementById('connect');

		function log(msg) {
			const line = document.createElement('div');
			line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
			logEl.appendChild(line);
			logEl.scrollTop = logEl.scrollHeight;
		}

		// Listen for state changes
		manager.on('state_change', (state) => {
			statusEl.textContent = `Status: ${state}`;
			log(`State: ${state}`);
		});

		// Listen for data channel messages
		manager.on('data_channel_message', ({ channel, data }) => {
			log(`Received: ${data}`);
		});

		manager.on('data_channel_open', (channel) => {
			log(`Data channel "${channel.label}" opened!`);
		});

		// Send ICE candidates to peer2 via parent
		manager.on('ice_candidate', (candidate) => {
			if (candidate) {
				window.parent.postMessage({
					from: 'peer1',
					to: 'peer2',
					type: 'ice-candidate',
					payload: candidate.toJSON(),
				}, '*');
			}
		});

		// Listen for signaling messages from peer2
		window.addEventListener('message', async (event) => {
			const { from, type, payload } = event.data;
			if (from !== 'peer2') return;

			if (type === 'answer') {
				log('Received answer from peer2');
				await manager.setRemoteDescription(payload);
			} else if (type === 'ice-candidate') {
				await manager.addIceCandidate(payload);
			}
		});

		// Connect button - initiates the connection
		connectBtn.addEventListener('click', async () => {
			connectBtn.disabled = true;
			log('Starting connection...');

			await manager.connect();
			const offer = await manager.createOffer();
			await manager.setLocalDescription(offer);

			// Send offer to peer2 via parent
			window.parent.postMessage({
				from: 'peer1',
				to: 'peer2',
				type: 'offer',
				payload: offer,
			}, '*');
			log('Sent offer to peer2');
		});

		// Send message button
		sendBtn.addEventListener('click', () => {
			const msg = messageInput.value.trim();
			if (msg) {
				const sent = manager.sendData('chat', msg);
				if (sent) {
					log(`Sent: ${msg}`);
					messageInput.value = '';
				} else {
					log('Failed to send (channel not open)');
				}
			}
		});

		messageInput.addEventListener('keypress', (e) => {
			if (e.key === 'Enter') sendBtn.click();
		});

		log('Ready. Click "Connect" to start.');
	</script>
</body>
</html>
