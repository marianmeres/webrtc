<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>Peer 1</title>
		<style>
			body {
				font-family: sans-serif;
				padding: 1rem;
			}
			h2 {
				margin-bottom: 1rem;
				color: #333;
			}
			#status {
				margin-bottom: 1rem;
				padding: 0.5rem;
				background: #f0f0f0;
			}
			#log {
				height: 200px;
				overflow-y: auto;
				border: 1px solid #ccc;
				padding: 0.5rem;
				margin-bottom: 1rem;
				font-size: 0.85rem;
			}
			.controls {
				display: flex;
				gap: 0.5rem;
				margin-bottom: 1rem;
			}
			input {
				flex: 1;
				padding: 0.5rem;
			}
			button {
				padding: 0.5rem 1rem;
				cursor: pointer;
			}
		</style>
	</head>
	<body>
		<h2>Peer 1 (Offerer)</h2>
		<div id="status">Status: Initializing...</div>
		<div id="log"></div>
		<div class="controls">
			<input type="text" id="message" placeholder="Type a message..." />
			<button id="send">Send</button>
		</div>
		<div class="controls">
			<button id="connect">Connect</button>
			<button id="beep" disabled>Send Beep</button>
		</div>
		<audio id="remoteAudio" autoplay></audio>

		<script type="module">
			import { WebRTCManager } from "./dist/webrtc.js";
			import {
				factory,
				peerConfig,
				setupBidirectionalAudio,
				sendBeep,
				createLogger,
			} from "./peer.js";

			const manager = new WebRTCManager(factory, {
				peerConfig,
				dataChannelLabel: "chat",
			});

			const statusEl = document.getElementById("status");
			const logEl = document.getElementById("log");
			const messageInput = document.getElementById("message");
			const sendBtn = document.getElementById("send");
			const connectBtn = document.getElementById("connect");
			const beepBtn = document.getElementById("beep");
			const remoteAudio = document.getElementById("remoteAudio");

			const log = createLogger(logEl);

			// Listen for state changes
			manager.on("state_change", (state) => {
				statusEl.textContent = `Status: ${state}`;
				log(`State: ${state}`);
				// Enable beep button when connected
				beepBtn.disabled = state !== "CONNECTED";
			});

			// Listen for data channel messages
			manager.on("data_channel_message", ({ channel, data }) => {
				log(`Received: ${data}`);
			});

			manager.on("data_channel_open", (channel) => {
				log(`Data channel "${channel.label}" opened!`);
			});

			// Listen for remote audio stream
			manager.on("remote_stream", (stream) => {
				if (stream) {
					remoteAudio.srcObject = stream;
					log("Playing received audio!");
				}
			});

			// Setup audio receiver when connected
			manager.on("state_change", (state) => {
				if (state === "CONNECTED") {
					const pc = manager.peerConnection;
					// Use the last audio transceiver (the one from negotiation)
					const audioTransceivers = pc
						.getTransceivers()
						.filter((t) => t.receiver.track?.kind === "audio");
					const transceiver = audioTransceivers[audioTransceivers.length - 1];
					if (transceiver && transceiver.receiver.track) {
						remoteAudio.srcObject = new MediaStream([
							transceiver.receiver.track,
						]);
					}
				}
			});

			// Send ICE candidates to peer2 via parent
			manager.on("ice_candidate", (candidate) => {
				if (candidate) {
					window.parent.postMessage(
						{
							from: "peer1",
							to: "peer2",
							type: "ice-candidate",
							payload: candidate.toJSON(),
						},
						"*"
					);
				}
			});

			// Listen for signaling messages from peer2
			window.addEventListener("message", async (event) => {
				const { from, type, payload } = event.data;
				if (from !== "peer2") return;

				if (type === "answer") {
					log("Received answer from peer2");
					await manager.setRemoteDescription(payload);
				} else if (type === "ice-candidate") {
					await manager.addIceCandidate(payload);
				}
			});

			// Connect button - initiates the connection
			connectBtn.addEventListener("click", async () => {
				connectBtn.disabled = true;
				log("Starting connection...");

				await manager.connect();

				// Setup bidirectional audio BEFORE creating offer
				setupBidirectionalAudio(manager.peerConnection);

				const offer = await manager.createOffer();
				await manager.setLocalDescription(offer);

				// Send offer to peer2 via parent
				window.parent.postMessage(
					{
						from: "peer1",
						to: "peer2",
						type: "offer",
						payload: offer,
					},
					"*"
				);
				log("Sent offer to peer2");
			});

			// Send beep button - sends audio via WebRTC media track
			beepBtn.addEventListener("click", () => {
				const pc = manager.peerConnection;
				if (!pc) {
					log("Not connected");
					return;
				}

				log("Sending beep...");
				sendBeep(pc, 440, 1000);
				log("Beep sent!");
			});

			// Send message button
			sendBtn.addEventListener("click", () => {
				const msg = messageInput.value.trim();
				if (msg) {
					const sent = manager.sendData("chat", msg);
					if (sent) {
						log(`Sent: ${msg}`);
						messageInput.value = "";
					} else {
						log("Failed to send (channel not open)");
					}
				}
			});

			messageInput.addEventListener("keypress", (e) => {
				if (e.key === "Enter") sendBtn.click();
			});

			log('Ready. Click "Connect" to start.');
		</script>
	</body>
</html>
